<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê³ ë“ ë³‘ì› ì§ì› í¬í„¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .admin-card { background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%); border: 1px solid #fee2e2; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ì‚¬ìš©ìì˜ ì •ë³´ ìë™ ì„¸íŒ…
        const SPREADSHEET_ID = '1pbdHHfsAoy2PAWBcWJSa71qdRnWl4TzTqgHvdjTs4GQ';
        const API_URL = 'https://script.google.com/macros/s/AKfycbx9sqnqDZSeZcGyt77cFEAzDVYKHm6ptHBSjk1w_ZR_Fbz_P0o3VAJrqKUGRZgqWGJJfQ/exec'; 
        const STAFF_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=staff`;
        const NOTICE_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=notices`;

        const App = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [isAdmin, setIsAdmin] = useState(false);
            const [activeTab, setActiveTab] = useState('home');
            const [user, setUser] = useState({ name: '', id: '' });
            const [staffList, setStaffList] = useState([]);
            const [notices, setNotices] = useState([]);
            const [newNotice, setNewNotice] = useState('');
            const [loading, setLoading] = useState(false);

            // ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
            const fetchData = async () => {
                try {
                    // ì§ì› ì •ë³´ ë¡œë“œ
                    const sRes = await fetch(STAFF_URL);
                    const sText = await sRes.text();
                    const sJson = JSON.parse(sText.substr(47).slice(0, -2));
                    setStaffList(sJson.table.rows.map(r => ({
                        id: String(r.c[0]?.v || ''),
                        name: String(r.c[1]?.v || ''),
                        role: String(r.c[2]?.v || '').toLowerCase()
                    })));

                    // ê³µì§€ì‚¬í•­ ë¡œë“œ
                    const nRes = await fetch(NOTICE_URL);
                    const nText = await nRes.text();
                    const nJson = JSON.parse(nText.substr(47).slice(0, -2));
                    setNotices(nJson.table.rows.map(r => ({
                        content: r.c[0]?.v || '',
                        date: r.c[1]?.v || ''
                    })).reverse()); // ìµœì‹ ìˆœ
                } catch (e) { console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", e); }
            };

            useEffect(() => { fetchData(); }, []);

            // ê³µì§€ì‚¬í•­ ë“±ë¡ (ê´€ë¦¬ì ì „ìš©)
            const handleAddNotice = async () => {
                if (!newNotice.trim()) return;
                setLoading(true);
                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors', // CORS ì´ìŠˆ ë°©ì§€
                        body: JSON.stringify({
                            sheetName: 'notices',
                            content: newNotice,
                            date: new Date().toLocaleDateString('ko-KR')
                        })
                    });
                    alert('ê³µì§€ê°€ ì‹œíŠ¸ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    setNewNotice('');
                    setTimeout(fetchData, 1500); // ì‹œíŠ¸ ë°˜ì˜ ì‹œê°„ ëŒ€ê¸° í›„ ê°±ì‹ 
                } catch (e) {
                    alert('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                } finally {
                    setLoading(false);
                }
            };

            const handleLogin = (e) => {
                e.preventDefault();
                const found = staffList.find(s => s.id === user.id && s.name === user.name);
                if (found) {
                    setIsLoggedIn(true);
                    if (found.role === 'admin') setIsAdmin(true);
                } else {
                    alert('ë“±ë¡ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ë¦„ê³¼ ì‚¬ë²ˆì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            };

            if (!isLoggedIn) return (
                <div className="flex items-center justify-center min-h-screen bg-[#003066] p-6">
                    <div className="bg-white/10 backdrop-blur-lg p-8 rounded-[2.5rem] w-full max-w-sm border border-white/20">
                        <h2 className="text-2xl font-bold text-white mb-8 text-center uppercase tracking-widest">Gordon Portal</h2>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input type="text" placeholder="ì„±í•¨" className="w-full p-4 rounded-2xl bg-white text-slate-800 outline-none" onChange={e => setUser({...user, name: e.target.value})} />
                            <input type="text" placeholder="ì‚¬ë²ˆ" className="w-full p-4 rounded-2xl bg-white text-slate-800 outline-none" onChange={e => setUser({...user, id: e.target.value})} />
                            <button className="w-full bg-blue-500 text-white p-4 rounded-2xl font-bold hover:bg-blue-400 active:scale-95 transition-all">ë¡œê·¸ì¸</button>
                        </form>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen pb-28">
                    <header className="bg-[#003066] text-white p-6 rounded-b-[2.5rem] shadow-xl flex justify-between items-end">
                        <div>
                            <p className="text-[10px] opacity-50 font-bold mb-1 uppercase tracking-tighter">Staff Only</p>
                            <h1 className="text-xl font-bold">{user.name} {isAdmin ? 'ê´€ë¦¬ì' : 'ë‹˜'}</h1>
                        </div>
                        <button onClick={() => window.location.reload()} className="text-[10px] bg-white/10 px-3 py-1.5 rounded-full font-bold">ë¡œê·¸ì•„ì›ƒ</button>
                    </header>

                    <main className="p-6">
                        {/* ê´€ë¦¬ì ê³µì§€ ì‘ì„±ì°½ */}
                        {isAdmin && (
                            <div className="admin-card p-6 rounded-[2rem] mb-8 shadow-sm">
                                <h3 className="text-red-600 font-bold mb-3 flex items-center gap-2">ğŸ“¢ ê³µì§€ì‚¬í•­ ë“±ë¡ (ê´€ë¦¬ì)</h3>
                                <textarea 
                                    className="w-full p-4 rounded-2xl border border-red-100 bg-white text-sm h-28 focus:ring-2 ring-red-100 outline-none transition-all"
                                    placeholder="ì „ ì§ì›ì—ê²Œ ì „ë‹¬í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."
                                    value={newNotice}
                                    onChange={e => setNewNotice(e.target.value)}
                                ></textarea>
                                <button 
                                    onClick={handleAddNotice}
                                    disabled={loading}
                                    className={`w-full mt-3 p-4 rounded-2xl font-bold text-white shadow-lg transition-all ${loading ? 'bg-slate-300' : 'bg-red-500 active:scale-95'}`}
                                >
                                    {loading ? 'ì‹œíŠ¸ì— ì €ì¥ ì¤‘...' : 'ê³µì§€ ì˜¬ë¦¬ê¸°'}
                                </button>
                            </div>
                        )}

                        {/* ê³µì§€ì‚¬í•­ ëª©ë¡ */}
                        <div className="space-y-4">
                            <h3 className="font-bold text-slate-800 flex items-center gap-2 px-2">ìµœì‹  ê³µì§€</h3>
                            {notices.length > 0 ? notices.map((n, i) => (
                                <div key={i} className="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 animate-in fade-in duration-500">
                                    <p className="text-sm text-slate-700 leading-relaxed break-all">{n.content}</p>
                                    <p className="text-[10px] text-slate-400 mt-3 font-medium">{n.date}</p>
                                </div>
                            )) : (
                                <div className="py-20 text-center text-slate-300 text-sm">ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                            )}
                        </div>
                    </main>

                    {/* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */}
                    <nav className="fixed bottom-6 left-6 right-6 bg-white/80 backdrop-blur-xl shadow-2xl rounded-full flex justify-around p-2 border border-white">
                        <button onClick={() => setActiveTab('home')} className={`p-4 rounded-full transition-all ${activeTab === 'home' ? 'bg-[#003066] text-white shadow-lg' : 'text-slate-300'}`}>ğŸ </button>
                        <button onClick={() => alert('ì¼ì • ê´€ë¦¬ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.')} className="p-4 text-slate-300">ğŸ“…</button>
                        <button onClick={() => setActiveTab('profile')} className={`p-4 rounded-full transition-all ${activeTab === 'profile' ? 'bg-[#003066] text-white shadow-lg' : 'text-slate-300'}`}>ğŸ‘¤</button>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
